# タスク: ログイン認証サービス

**入力**: 設計ドキュメント `/specs/001-docs-requirements-md/`
**前提条件**: plan.md（必須）、research.md、data-model.md、contracts/

## 実行フロー（メイン）
```
1. 機能ディレクトリからplan.mdをロード
   → ✅ 完了
   → 抽出: 技術スタック、ライブラリ、構造
2. オプションの設計ドキュメントをロード:
   → data-model.md: エンティティ抽出 → モデルタスク
   → contracts/: 各ファイル → コントラクトテストタスク
   → research.md: 決定事項抽出 → セットアップタスク
3. カテゴリ別にタスクを生成:
   → セットアップ: プロジェクト初期化、依存関係、リンティング
   → テスト: コントラクトテスト、統合テスト
   → コア: モデル、サービス、エンドポイント
   → 統合: ミドルウェア、ロギング
   → 仕上げ: ドキュメント、手動テスト
4. タスクルールを適用:
   → 異なるファイル = [P]マーク（並列実行可能）
   → 同じファイル = 順次実行（[P]なし）
   → テストを実装前に実施（TDD）
5. タスクに順次番号付け（T001、T002...）
6. 依存関係グラフ生成
7. 並列実行例を作成
8. タスク完全性を検証:
   → すべてのコントラクトにテストがあるか？
   → すべてのエンティティにモデルがあるか？
   → すべてのエンドポイントが実装されているか？
9. 結果: 成功（タスク実行準備完了）
```

## フォーマット: `[ID] [P?] 説明`
- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- 説明に正確なファイルパスを含める

## パス規則
- **Webアプリ**: `auth-app/server/`（バックエンド）、`auth-app/public/`（フロントエンド）
- 以下のパスはplan.mdの構造に基づく

---

## フェーズ3.1: セットアップ

### T001: プロジェクト構造の作成
**ファイル**: `auth-app/` ディレクトリ全体
**説明**: plan.mdに従ってプロジェクト構造を作成
```
auth-app/
├── server/
│   ├── index.js
│   ├── routes/
│   └── views/
├── public/
│   ├── css/
│   └── js/
├── package.json
└── README.md
```
**依存関係**: なし

### T002: Node.jsプロジェクトの初期化と依存関係インストール
**ファイル**: `auth-app/package.json`
**説明**: 
- `npm init` でpackage.jsonを作成
- Node.js 22+を指定
- 依存関係をインストール:
  - express@4.x
  - ejs
- 開発依存関係:
  - nodemon（開発サーバー）
**依存関係**: T001完了後

### T003 [P]: ESLintとPrettierの設定
**ファイル**: `auth-app/.eslintrc.json`, `auth-app/.prettierrc`
**説明**: コードスタイルと品質チェックツールを設定
**依存関係**: T002完了後

---

## フェーズ3.2: バックエンド実装

### T004: Expressサーバーのエントリーポイント作成
**ファイル**: `auth-app/server/index.js`
**説明**:
- Expressアプリケーションを初期化
- EJSをビューエンジンとして設定
- 静的ファイル提供（public/）
- ポート3000でリッスン
- ミドルウェア設定（body-parser for JSON and form data）
**依存関係**: T002完了後

### T005: POST /authエンドポイント実装
**ファイル**: `auth-app/server/routes/auth.js`
**説明**:
- POSTリクエストボディから `callback` パラメータを取得
- callbackが未提供の場合はデフォルトURL（https://example.com/auth-success）を使用
- ログイン画面（login.ejs）をレンダリング
- callbackUrlをテンプレートに渡す
**依存関係**: T004完了後

### T006: ログイン画面のEJSテンプレート作成（Bootstrap 5使用）
**ファイル**: `auth-app/server/views/login.ejs`
**説明**:
- Bootstrap 5をCDN経由で読み込み
- レスポンシブなログインフォームを作成
- フィールド: 企業ID、メール、パスワード
- Bootstrapクラス使用: `form-control`, `btn-primary`, `container`, `card`
- callbackUrlをJavaScript変数として埋め込み（`window.CALLBACK_URL`）
- joseライブラリをCDN経由で読み込み（JWT生成用）
**依存関係**: T005完了後

---

## フェーズ3.3: フロントエンド実装

### T007 [P]: カスタムCSSファイル作成
**ファイル**: `auth-app/public/css/custom.css`
**説明**:
- Bootstrap拡張のカスタムスタイル
- ログイン画面のセンタリング
- エラーフィールドのハイライトスタイル
**依存関係**: T003完了後

### T008: クライアント側JWT生成とリダイレクト処理
**ファイル**: `auth-app/public/js/auth.js`
**説明**:
- フォーム送信イベントをキャプチャ
- 入力バリデーション（空チェック）
- エラー時はBootstrapの `is-invalid` クラスを追加
- バリデーション成功時:
  - JWTペイロード生成（companyId、userId: "mock-user-123"、accessToken: UUID、expiresAt: 現在+24時間）
  - joseライブラリでJWT署名（秘密鍵: "mock-secret-key-do-not-use-in-production"、アルゴリズム: HS256）
  - `{callbackUrl}#token={jwt}` にリダイレクト
**依存関係**: T006完了後

---

## フェーズ3.4: 統合とテスト準備

### T009: サーバーとルーティングの統合
**ファイル**: `auth-app/server/index.js`（更新）
**説明**:
- auth.jsルーターをExpressアプリに統合
- エラーハンドリングミドルウェアを追加
- 404ハンドラーを追加
**依存関係**: T005完了後

### T010: 環境変数の設定（オプション）
**ファイル**: `auth-app/.env.example`
**説明**:
- PORT（デフォルト: 3000）
- DEFAULT_CALLBACK_URL（デフォルト: https://example.com/auth-success）
- JWT_SECRET（デフォルト: mock-secret-key-do-not-use-in-production）
**依存関係**: T009完了後

---

## フェーズ3.5: ドキュメントと仕上げ

### T011 [P]: README.mdの作成
**ファイル**: `auth-app/README.md`
**説明**:
- プロジェクト概要
- セットアップ手順（npm install、npm start）
- 使用方法（POSTリクエスト例）
- 技術スタック
- 注意事項（モック用途のみ）
**依存関係**: T010完了後

### T012: quickstart.mdに基づく手動テスト実行
**ファイル**: なし（手動テスト）
**説明**:
- quickstart.mdの4つのシナリオを実行:
  1. 正常系: すべてのフィールドを入力してログイン
  2. エッジケース: 入力フィールドが空
  3. エッジケース: コールバックURLなし
  4. 認証チェックなし: どの値でもログイン成功
- すべてのシナリオが合格することを確認
**依存関係**: T008、T009完了後

---

## 依存関係グラフ

```
T001 (プロジェクト構造)
  ↓
T002 (npm init + 依存関係)
  ↓
T003 [P] (Lint設定) ────────────┐
  ↓                            ↓
T004 (Expressサーバー)         T007 [P] (カスタムCSS)
  ↓
T005 (POST /authエンドポイント)
  ↓
T006 (login.ejsテンプレート)
  ↓
T008 (JWT生成JS)
  ↓
T009 (統合)
  ↓
T010 (環境変数)
  ↓
T011 [P] (README) ────────────┐
  ↓                           ↓
T012 (手動テスト実行)
```

---

## 並列実行例

### 例1: セットアップフェーズ後
```bash
# T003とT007を並列実行（異なるファイル、依存関係なし）
# T003が完了後、T004を開始
# T002が完了後、T007を開始
```

### 例2: 最終フェーズ
```bash
# T011（README作成）を実行
# その後T012（手動テスト）を実行
```

**注意**: このプロジェクトはモックサービスでファイル数が少ないため、並列実行の機会は限定的です。

---

## タスク完了チェックリスト

### セットアップ
- [ ] T001: プロジェクト構造作成完了
- [ ] T002: Node.jsプロジェクト初期化完了
- [ ] T003: ESLint/Prettier設定完了

### バックエンド
- [ ] T004: Expressサーバー作成完了
- [ ] T005: POST /authエンドポイント実装完了
- [ ] T006: login.ejsテンプレート作成完了

### フロントエンド
- [ ] T007: カスタムCSS作成完了
- [ ] T008: JWT生成・リダイレクト実装完了

### 統合
- [ ] T009: サーバー統合完了
- [ ] T010: 環境変数設定完了

### 仕上げ
- [ ] T011: README作成完了
- [ ] T012: 手動テスト全シナリオ合格

---

## 検証ゲート

### 全体検証
- [ ] すべてのエンドポイント（POST /auth）が実装されている
- [ ] Bootstrap 5が正しく使用されている
- [ ] POSTリクエストボディでコールバックURLを受け取る仕様が満たされている
- [ ] JWT生成が正しく動作する（ペイロード4フィールド、署名、無期限）
- [ ] リダイレクトがURLフラグメント形式（#token=...）で動作する
- [ ] すべての手動テストシナリオが合格
- [ ] Node.js 22+で動作する

---

## ノート

### 重要事項
- モックサービスのため自動テストは不要（quickstart.mdの手動テストのみ）
- Bootstrap 5を積極的に使用（form-control、is-invalid、card等）
- JWT生成はブラウザ側で実行（サーバー負荷軽減）
- POSTリクエストボディでコールバックURLを受け取る（仕様要件）

### タスク実行のベストプラクティス
- 各タスク完了後にコミット
- ファイルパスを正確に確認
- [P]タスクは同じファイルを変更しないことを確認
- 手動テストは最後に必ず実行

---

## タスク生成ルール適用結果

### コントラクトから
- ✅ POST /authエンドポイント → T005実装タスク

### データモデルから
- ✅ LoginCredentials → T006, T008（フォームとバリデーション）
- ✅ JWTPayload → T008（JWT生成ロジック）
- ✅ CallbackParameters → T005（POSTボディ処理）

### ユーザーストーリーから
- ✅ quickstart.mdの4シナリオ → T012手動テスト

### 順序付け
- ✅ セットアップ → バックエンド → フロントエンド → 統合 → 仕上げ

---

*タスクリストv1.0 - 2025-10-02作成*
